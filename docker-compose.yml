services:
  # Nginx - единственная точка входа, прокси для Frontend и Backend
  nginx:
    image: nginx:alpine
    container_name: autello_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - autello_network
    restart: unless-stopped

  # PostgreSQL - база данных
  postgres:
    image: postgres:16-alpine
    container_name: autello_postgres
    environment:
      POSTGRES_DB: autello_db
      POSTGRES_USER: autello_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - autello_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U autello_user -d autello_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin - веб-интерфейс для управления PostgreSQL (отключен)
  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: autello_pgadmin
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@autello.com}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-change_me_in_production}
  #     PGADMIN_CONFIG_SERVER_MODE: 'False'
  #     PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
  #     PGADMIN_CONFIG_CHECK_EMAIL_DELIVERABILITY: 'False'
  #   volumes:
  #     - pgadmin_data:/var/lib/pgadmin
  #   ports:
  #     - "5050:80"
  #   depends_on:
  #     - postgres
  #   networks:
  #     - autello_network
  #   restart: unless-stopped

  # Backend - серверная часть приложения (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: autello_backend
    environment:
      POSTGRES_USER: autello_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
      POSTGRES_DB: autello_db
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - autello_network
    restart: unless-stopped
    # Порт доступен только внутри Docker network для Nginx
    expose:
      - "8000"

  # Watchtower - автоматическое обновление контейнеров
  watchtower:
    image: containrrr/watchtower:latest
    container_name: autello_watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=3600
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
    networks:
      - autello_network
    restart: unless-stopped
    # Watchtower не должен обновлять сам себя
    command: --label-enable --interval 3600

  # Docker Registry - локальный реестр для образов (отключен)
  # registry:
  #   image: registry:2
  #   container_name: autello_registry
  #   ports:
  #     - "5000:5000"
  #   environment:
  #     # TLS настройки (раскомментируйте после создания сертификатов)
  #     # REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt
  #     # REGISTRY_HTTP_TLS_PRIVATE_KEY: /certs/domain.key
  #     # Аутентификация
  #     REGISTRY_AUTH: htpasswd
  #     REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
  #     REGISTRY_AUTH_HTPASSWD_REALM: "Autello Docker Registry"
  #     REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
  #     # HTTP Secret для безопасности
  #     REGISTRY_HTTP_SECRET: ${REGISTRY_HTTP_SECRET:-728aa6f4542f677d435fd30f58eb553df5c363b73049cd97bfba6a9369a4c36c}
  #   volumes:
  #     - registry_data:/var/lib/registry
  #     - ./registry/auth:/auth:ro
  #     # Раскомментируйте после создания сертификатов
  #     # - ./registry/certs:/certs:ro
  #   networks:
  #     - autello_network
  #   restart: unless-stopped
  #   labels:
  #     - "com.centurylinklabs.watchtower.enable=false"

volumes:
  postgres_data:
    driver: local

networks:
  autello_network:
    driver: bridge
    internal: false

